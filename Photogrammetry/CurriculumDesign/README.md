### 大三下摄影测量课程设计（程序二）

>程序一见本仓库项目  **Qt/forward_intersection** [点我去看](https://gitee.com/xiaoke0o/UniversityCodeWork/tree/master/Qt/forward_intersection)

> 要把这个程序讲清楚不容易

#### 程序内容

由程序一计算得到的42个像点的地面点坐标，结合像片的外方位元素，通过共线条件方程线性化逐点列出误差方程。

本程序要做的，就是得到这个误差方程的所有系数，并且要将得到的结果输出到Excel表格(**难点)**。



#### 原理

##### 光束法区域网平差

1. 像片外方位元素和地面点坐标近似值的确定（航带法）。
2. 从每幅影像上的控制点和待定点的像点坐标出发，按照共线条件方程逐点列出误差方程式。
3. 逐点法化并解求改化法方程式。
4. 求出每一张像片的外方位元素。
5. 空间前方交会解求待定点的地面坐标，各片公共连接点取均值作为最后结果。

这是光束法区域网平差的步骤，本程序要做的是第2步，逐点列出误差方程，即得到这个误差方程组的系数。

**误差方程组 长这样**

![误差方程组](https://images.gitee.com/uploads/images/2020/0224/221957_d2bce845_5199880.png "屏幕截图.png")


我们已经知道一共有42的像点

每个像点可以列一个这样的方程组，所以可以列84行。

#### 程序实现

> 语言：C++
>
> 用到的库：Eigen3（线性代数库）

该程序主要利用了C++类的概念，将该项目封装了一个Design(设计)类，在主函数中创建一个Design 类的对象，用该对象传入输入文件及输出文件路径，另外也可以用该对象输出一些项目的属性信息，如总点数、像片数等。

这样想做的好处是主函数交互清晰，方便使用；坏处是不容一看懂源代码，需要读者有一定熟悉类及相关属性的概念。项目文件目录如下：

```shell
 Coefficient_matrix
│  CMakeLists.txt
│  Design.cpp #类的实现文件
│  Design.h #类的声明及头文件声明
│  main.cpp #类的对象创建及交互
│  README.md
|
└─files
        42.csv #点位信息文件
        control.txt
        output.xls #输出文件
```

##### 结果输出

> 我们先开讲一下结果输出这个重点。
>
> 虽然在作业要求中只是要求将结果输出到EXCEL，但是要完美的做好不容易。

回归初心，老师的目的应该是**把结果以一种可视化的方式展现**，能够看出来其排布规律(其实也没什么规律)。

重点不是输出文件的格式是EXCEL格式还是其他的什么文本格式。

一般人可能只知道excel能打开的是xls或者xlsx后缀的文件，却不知道excel也可以导入文本或者打开CSV文件。

出于一个完美主义者的考量，结果当然是输出到xls/xlsx文件中，直接用Excel打开，但是xls/xlsx文件作为Excel的一种二进制文件，C++/C 是无法直接生成的。这就好比一张图片，我们知道其实是矩阵和颜色表组成的但是我们无法直接用C/C++输出一张图片。就算你在程序中将输出文件命名为xxx.xls或者xxx.xlsx文件，其实也还是txt文件，不是正宗的xls/xlsx文件。

既然不能直接生成，就还得能用Excel打开，那该用什么方法呢？折中的办法是生成CSV文件，CSV文件用分隔符(一般是逗号)来分割相邻数据，可以理解成是由格式的txt文件，并且可以直接用Excel打开，不过打开是导入数据，然后就可以像xls/xlsx文件一样操作了。



扯了这么多其实是想说，输出结果到文件并用一种可视化的方式展现（Excel），是不能直接生成Excel格式文件的。当然可以用一些xls文件读写库，直接在程序中建立xls文件并将数据输出到xls文件，这样是正宗的xls/xlsx文件，但是我觉得这样做就有点本末倒置了，虽然结果很漂亮，甚至可以直接设置表头，单元格颜色等属性。不过我觉得这不是重点。

##### 计算部分

> 原则：通用、尽量少的外部干预。

计算部分主要是根据共线条件方程和共线条件方程的线性化确定系数的值，这不是难点，难点在于数据的排布。

对于A系数阵。我要知道这两行六列数在哪个图片的列下边，首先要知道知道这个点在哪张相片上，这个可以用输入文件的第一列`index`变量获取，这两行六列数写在哪张照片的底下，这和照片在矩阵中的列数就是`(index-1)*6`,在计算每一行的时候，先判断这两行六列数在整个矩阵中的起始列`A_begin_col`，再给相应的位置赋值。

对于B系数阵。比A阵稍微有点费心，b矩阵要求写到非控制点的点下面，但是在读数据的时候，你不知道这个点是几号点，就不知道要放到那一列下边，只知道这个点是不是控制点（该不该计算）。这就要求我们的读入的数据的顺序和矩阵从左至右排列的顺序是一致的，这样才能按顺序间接达到对号入座，而不是像A矩阵一样直接去找自己的位置。**这么做是一种讨巧的办法**。如果能在读取数据中再增加一列，标明这个点是几号点，我想问题就解决了。

对于L阵。这就简单了，每读取一行，计算一个x，一个y，分布到矩阵的最后一列。

#### 外部库Eigen3

这里程序用了一个外部函数库Eigen，这一个C的线性代数的数学库，说白了就是算矩阵的。计算速度很快，设置也相当简单。只需要下载下来，并在项目中设置文件目录，程序中·包含这个头文件就可以，不需要额外的链接库。
